<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="Content/bootstrap.min.css">
</head>
<body>

    <nav class="navbar navbar-fixed-top navbar-static-top" style="background-color: #242323; ">
        <a href="#table" class="navbar-brand">
                Letovi
        </a>
        <a href="#airlines" class="navbar-brand">
            Aviokompanije
        </a>
    </nav>

    <section id="table">
        <h2>Letovi</h2>
        <div>
            <form id="searchForm" action="/api/default" method="post" onsubmit="resetFormFields()">
                <table>
                    <tr>
                        <td>
                            <label>Polazište</label>
                        </td>
                        <td>
                            <input type="text" placeholder="Polazište" id="pocetna_destinacija" name="startDestination" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Odredište</label>
                        </td>
                        <td>
                            <input type="text" placeholder="Odredište" id="odredisna_destinacija" name="endDestination" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Aviokompanija</label>
                        </td>
                        <td>
                            <input type="text" placeholder="Aviokompanija" id="aviokompanija" name="airlinesName" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Datum polaska</label>
                        </td>
                        <td>
                            <input type="date" id="datum_polaska" name="departureDate" />

                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Datum dolaska</label>

                        </td>
                        <td>
                            <input type="date" id="datum_dolaska" name="arrivalDate" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input class="btn btn-success" type="submit" value="PRETRAŽI" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>

        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Polazna destinacija</th>
                    <th scope="col">Odredišna destinacija</th>
                    <th scope="col">Datum polaska</th>
                    <th scope="col">Datum dolaska</th>
                    <th scope="col">Slobodna mjesta</th>
                    <th scope="col">Aviokompanija</th>
                    <th style="cursor:pointer" scope="col" onclick="sortTable()">Cijena</th>
                </tr>
            </thead>
            <tbody id="flights-table-body">
            </tbody>
        </table>
    </section>


    <section id="airlines">
        <h2>Aviokompanije</h2>

        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Aviokompanija</th>
                    <th scope="col">e-mail</th>
                </tr>
            </thead>
            <tbody id="airlines-table-body">
            </tbody>
        </table>

    </section>

    <script src="Scripts/jquery-1.10.2.js"></script>
    <script>
        var sortOrder = false;


        function loadAirlines() {
            $.get("api/airlines", function (data, status) {
                var airlines = data;
                var tbody = $("#airlines-table-body");
                tbody.empty(); // Clear any existing rows

                var i = 0;
                airlines.forEach(function (airline, index) {
                    ++i;
                    var row = `<tr>
                                    <td>${i}</td>
                                    <td>${airline.Name}</td>
                                    <td>${airline.ContactInfo.split('/phone:')[0].split('email: ')[1]}</td>
                                </tr>`;
                    tbody.append(row);
                })
            });
        }

        function sortTable() {
            var tbody = document.querySelector("#flights-table-body");
            var rows = Array.from(tbody.rows);
            var flights = [];

            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].cells;
                var flight = new Flight(
                    cells[0].innerText,
                    cells[1].innerText,
                    cells[2].innerText,
                    cells[3].innerText,
                    cells[4].innerText,
                    cells[5].innerText,
                    cells[6].innerText,
                    parseFloat(cells[7].innerText.substring(1))
                );
                flights.push(flight);
            }

            sortOrder = !sortOrder;
            // Sort the flights array by price
            if (sortOrder) {
                flights.sort(function (a, b) {
                    return a.Price - b.Price;
                });
            }
            else {
                flights.sort(function (a, b) {
                    return b.Price - a.Price;
                });
            }

            tbody.innerHTML = "";

            flights.forEach(function (flight, index) {
                var row = `<tr>
                    <td scope="row" id="row_index">${index + 1}</td>
                    <td id="table_startDestination">${flight.StartDestination}</td>
                    <td id="table_endDestination">${flight.EndDestination}</td>
                    <td id="table_departure">${flight.DepartureDateTime}</td>
                    <td id="table_arrival">${flight.ArrivalDateTime}</td>
                    <td id="table_freeSeats">${flight.NumberOf_FreeSeats}</td>
                    <td id="table_airlines"><a href="Airline.html?airline=${encodeURIComponent(flight.Airlines)}">${flight.Airlines}</a></td>
                    <td id="table_price">$${flight.Price}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        };

        function Flight(rowIndex, startDestination, endDestination, departure, arrival, freeSeats, airlines, price) {
            this.RowIndex = rowIndex;
            this.StartDestination = startDestination;
            this.EndDestination = endDestination;
            this.DepartureDateTime = departure;
            this.ArrivalDateTime = arrival;
            this.NumberOf_FreeSeats = freeSeats;
            this.Airlines = airlines;
            this.Price = price;
        };

        function loadFlights() {
            $.get("api/default", function (data, status) {
                var flights = data;
                var tbody = $("#flights-table-body");
                tbody.empty(); // Clear any existing rows

                var i = 0;
                flights.forEach(function (flight) {
                    if (flight.Status === 0) {
                        ++i;
                        var row = `<tr>
                                        <td scope="row">${i}</td>
                                        <td id="table_startDestination">${flight.StartDestination}</td>
                                        <td id="table_endDestination">${flight.EndDestination}</td>
                                        <td id="table_departure">${flight.DepartureDateTime}</td>
                                        <td id="table_arrival">${flight.ArrivalDateTime}</td>
                                        <td id="table_freeSeats">${flight.NumberOf_FreeSeats}</td>
                                        <td id="table_airlines"><a href="Airline.html?airline=${encodeURIComponent(flight.Aviokompanija.Name)}">${flight.Aviokompanija.Name}</a></td>
                                        <td id="table_price">$${flight.Price}</td>
                                    </tr>`;
                        tbody.append(row);
                    }
                });
            });
        }

        function resetFormFields() {
            // Delay form reset by a short timeout to ensure submission completes
            setTimeout(function () {
                document.getElementById("searchForm").reset();
                loadFlights();
            }, 100);
        }

        $(document).ready(function () {
            loadFlights();
            loadAirlines();
        });

    </script>
</body>
</html>