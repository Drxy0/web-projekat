<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="Content/bootstrap.min.css">
    <script src="Scripts/jquery-1.10.2.js"></script>
    <style>
        form, p {
            padding-top: 20px;
            margin: 0 auto;
            width: 25vw;
        }
        body {
            padding-top: 50px;
        }
        h1, button{
            margin-left: 20px;
        }
        #adminUsersFormDiv {
            float: left;
            padding-bottom:10px;
        }
    </style>
    <title>Profile</title>
</head>
<body>
    <nav id="nav" class="navbar navbar-fixed-top navbar-static-top" style="background-color: #242323; ">
        <a href="Index.html" class="navbar-brand">
            Home
        </a>
    </nav>

    <h1>User profile</h1>
    <button type="button" class="btn btn-primary" onclick="editProfile()">Edit Profile</button>
    <button type="button" class="btn btn-primary" onclick="logOut()">Log Out</button>

    <br />
    <div id="adminUsersList">
        <h2>Svi korisnici</h2>
        <div id="adminUsersFormDiv">
            <form id="adminUsersForm" action="/api/default" method="post">
                <table>
                    <tr>
                        <td>
                            <label>Ime: </label>
                        </td>
                        <td>
                            <input type="text" placeholder="John" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Prezime: </label>
                        </td>
                        <td>
                            <input type="text" placeholder="Doe" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Datum rođenja (od): </label>
                        </td>
                        <td>
                            <input type="date" placeholder="01/01/1970" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Datum rođenja (do): </label>
                        </td>
                        <td>
                            <input type="date" placeholder="01/12/1999" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input class="btn btn-success" type="submit" value="PRETRAŽI" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <br />
        <table id="adminUsersTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th hidden>Flight Id</th>
                    <th scope="col">#</th>
                    <th scope="col">Ime</th>
                    <th scope="col">Prezime</th>
                    <th scope="col">Datum rođenja</th>
                </tr>
            </thead>
            <tbody id="adminUsersTableBody">
            </tbody>
        </table>
    </div>

    <div id="editDiv" hidden>
        <form id="registerForm">
            <h2 class="text-center">Edit Profile</h2>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="name">Name</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="John" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="surname">Surname</label>
                    <input type="text" class="form-control" id="surname" name="surname" placeholder="Doe" required>
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="birthday">Birthday</label>
                    <input type="date" class="form-control" id="birthday" name="birthday" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="gender">Gender</label>
                    <select id="gender" class="form-control" name="gender" required>
                        <option selected value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>


    <script>
        var user;
        $(document).ready(function () {
            loadUser();
        });

        function logOut() {
            sessionStorage.clear();
            window.location.href = "Index.html";
        }

        function loadUser() {
            $.get("api/users", function (data, status) {
                var userInfo = document.querySelector("#userInfo");
                var adminUsersList = document.querySelector("#adminUsersList");
                user = data.find(user => user.Username === sessionStorage.getItem("token"));
                role = sessionStorage.getItem("role");
                let gender = ["MALE", "FEMALE"];

                userInfo.innerHTML = `<h4>${user.Username}</h4> <br>
                                        <h4>${user.Name} ${user.Surname}</h4>
                                        <h4>${user.Email}</h4>
                                        <h4>${user.Birthday}</h4>
                                        <h4>${gender[user.Gender]}</h4>`;
                if (role == "PUTNIK") {
                    userInfo.innerHTML += '<h4> Reservations</h4>';
                } else if (role == "ADMINISTRATOR") {
                    adminFilterUsersForm();
                    adminLoadUsersList();
                }
                document.querySelector('#password').value = user.Password;
                document.querySelector('#name').value = user.Name;
                document.querySelector('#surname').value = user.Surname;
                document.querySelector('#email').value = user.Email;
                document.querySelector('#birthday').value = user.Birthday;
                document.querySelector('#gender').value = user.Gender === 0 ? 'Male' : 'Female';
            });
        }

        function adminFilterUsersForm() {

        }
        function adminLoadUsersList() {
            $.get("api/users", function (data, status) {
                var tbody = $("#adminUsersTableBody");
                tbody.empty(); // Clear any existing rows
                console.log(data);
                data.forEach(function (user, index) {
                    var row = `<tr>
                               <td>${index+1}</td>
                               <td>${user.Name}</td>
                               <td>${user.Surname}</td>
                               <td>${user.Birthday}</td>
                               </tr>`;
                    tbody.append(row);
                });
            });
        }
        function editProfile() {
            userInfo.hidden = true;
            var editDiv = document.querySelector("#editDiv");
            editDiv.hidden = false;
        }

        document.getElementById('registerForm').addEventListener('submit', function (event) {
            event.preventDefault();

            var formData = {
                username: user.Username,
                password: document.getElementById('password').value,
                name: document.getElementById('name').value,
                surname: document.getElementById('surname').value,
                email: document.getElementById('email').value,
                birthday: document.getElementById('birthday').value,
                gender: document.getElementById('gender').value
            };

            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            }).then(response => {
                location.reload();
            });


        });

    </script>
</body>
</html>