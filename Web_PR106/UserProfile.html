<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="Content/bootstrap.min.css">
    <script src="Scripts/jquery-1.10.2.js"></script>
    <style>
        form, p {
            padding-top: 20px;
            margin: 0 auto;
            width: 25vw;
        }
        body {
            padding-top: 50px;
        }
        h1, button{
            margin-left: 20px;
        }
        #adminUsersFormDiv {
            float: left;
            padding-bottom:10px;
        }
    </style>
    <title>Profile</title>
</head>
<body>
    <nav id="nav" class="navbar navbar-fixed-top navbar-static-top" style="background-color: #242323; ">
        <a href="Index.html" class="navbar-brand">
            Home
        </a>
        <a href="admin-airlines.html" class="navbar-brand">
            Aviokompanije
        </a>
        <a href="admin-flights.html" class="navbar-brand">
            Letovi
        </a>
        <a href="admin-reservations.html" class="navbar-brand">
            Rezervacije
        </a>
    </nav>

    <h1>User profile</h1>
    <button type="button" class="btn btn-primary" onclick="editProfile()">Edit Profile</button>
    <button type="button" class="btn btn-primary" onclick="logOut()">Log Out</button>

    <div id="userInfo" style="padding:20px">
    </div>

    <br />
    <div id="adminUsersList">
        <h2>Svi korisnici</h2>
        <div id="adminUsersFormDiv">
            <form id="adminUsersForm" action="/api/airlines/adminFilterAirlines" method="post">
                <table>
                    <tr>
                        <td>
                            <label>Ime: </label>
                        </td>
                        <td>
                            <input type="text" placeholder="John" name="name" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Prezime: </label>
                        </td>
                        <td>
                            <input type="text" placeholder="Doe" name="surname"/>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Datum rođenja (od): </label>
                        </td>
                        <td>
                            <input type="date" placeholder="01/01/1970" name="startDate"/>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Datum rođenja (do): </label>
                        </td>
                        <td>
                            <input type="date" placeholder="01/12/1999" name="endDate" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input class="btn btn-success" type="submit" value="PRETRAŽI" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <br />
        <table id="adminUsersTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th hidden>Flight Id</th>
                    <th scope="col">#</th>
                    <th id="sort-name-header" scope="col" onclick="sortTableByName()">Ime</th>
                    <th scope="col">Prezime</th>
                    <th id="sort-birthday-header" scope="col" onclick="sortTableByBirthday()">Datum rođenja</th>
                </tr>
            </thead>
            <tbody id="adminUsersTableBody">
            </tbody>
        </table>
    </div>

    <div id="editDiv" hidden>
        <form id="registerForm">
            <h2 class="text-center">Edit Profile</h2>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="name">Name</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="John" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="surname">Surname</label>
                    <input type="text" class="form-control" id="surname" name="surname" placeholder="Doe" required>
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="birthday">Birthday</label>
                    <input type="date" class="form-control" id="birthday" name="birthday" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="gender">Gender</label>
                    <select id="gender" class="form-control" name="gender" required>
                        <option selected value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>

    <script>
        var user;
        var sortOrder = false;
        const form = document.getElementById('adminUsersForm');

        const sortNameHeader = $("#sort-name-header");
        const sortBirthdayHeader = $("#sort-birthday-header");


        $(document).ready(function () {
            loadUser();
        });

        function logOut() {
            sessionStorage.clear();
            window.location.href = "Index.html";
        }

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(form);
            const jsonObject = {};
            formData.forEach((value, key) => {
                jsonObject[key] = value;
            });
            const jsonData = JSON.stringify(jsonObject);

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json()
                })
                .then(data => {
                    form.reset();
                    var tbody = $("#adminUsersTableBody");
                    tbody.empty();
                    data.forEach(function (user, index) {
                        var row = `<tr>
                                <td>${index + 1}</td>
                                <td>${user.Name}</td>
                                <td>${user.Surname}</td>
                                <td>${user.Birthday}</td>
                                </tr>`;
                        tbody.append(row);
                    });
                })
                .catch(error => {
                    console.error('Error occurred:', error);
                });
        });


        function User(name, surname, birthday) {
            this.Name = name;
            this.Surname = surname;
            this.Birthday = birthday;
        }


        function sortTableByName() {
            var tbody = $("#adminUsersTableBody");
            var rows = tbody.find("tr").get();
            var users = [];

            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].cells;
                var user = new User(
                    cells[1].innerText,
                    cells[2].innerText,
                    cells[3].innerText,
                );
                users.push(user);
            }

            sortOrder = !sortOrder;

            if (sortOrder) {
                sortNameHeader.text("Ime▲");
                users.sort(function (a, b) {
                    return a.Name.localeCompare(b.Name);
                });
            } else {
                sortNameHeader.text("Ime▼");
                users.sort(function (a, b) {
                    return b.Name.localeCompare(a.Name);
                });
            }

            if (sortBirthdayHeader.text != "Datum rođenja") {
                sortBirthdayHeader.text("Datum rođenja")
            }
            tbody.empty();
            users.forEach(function (user, index) {
                var row = `<tr>
                                <td>${index + 1}</td>
                                <td>${user.Name}</td>
                                <td>${user.Surname}</td>
                                <td>${user.Birthday}</td>
                           </tr>`;
                tbody.append(row);
            });
        }

        function sortTableByBirthday() {
            var tbody = $("#adminUsersTableBody");
            var rows = tbody.find("tr").get();
            var users = [];

            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].cells;
                var user = new User(
                    cells[1].innerText,
                    cells[2].innerText,
                    cells[3].innerText,
                );
                users.push(user);
            }

            sortOrder = !sortOrder;

            if (sortOrder) {
                sortBirthdayHeader.text("Datum rođenja▲");
                users.sort(function (a, b) {
                    var datePartsA = a.Birthday.split('/');
                    var datePartsB = b.Birthday.split('/');

                    var dateA = new Date(datePartsA[2], datePartsA[1] - 1, datePartsA[0]);
                    var dateB = new Date(datePartsB[2], datePartsB[1] - 1, datePartsB[0]);

                    return dateA - dateB;
                });
            } else {
                sortBirthdayHeader.text("Datum rođenja▼");
                users.sort(function (a, b) {
                    var datePartsA = a.Birthday.split('/');
                    var datePartsB = b.Birthday.split('/');

                    var dateA = new Date(datePartsA[2], datePartsA[1] - 1, datePartsA[0]);
                    var dateB = new Date(datePartsB[2], datePartsB[1] - 1, datePartsB[0]);

                    return dateB - dateA;
                });
            }

            if (sortNameHeader.text != "Ime") {
                sortNameHeader.text("Ime")
            }

            tbody.empty();
            users.forEach(function (user, index) {
                var row = `<tr>
                                <td>${index + 1}</td>
                                <td>${user.Name}</td>
                                <td>${user.Surname}</td>
                                <td>${user.Birthday}</td>
                           </tr>`;
                tbody.append(row);
            });
        }

        function loadUser() {
            $.get("api/users", function (data, status) {
                var userInfo = document.querySelector("#userInfo");
                var adminUsersList = document.querySelector("#adminUsersList");
                user = data.find(user => user.Username === sessionStorage.getItem("token"));
                role = sessionStorage.getItem("role");
                let gender = ["MALE", "FEMALE"];

                userInfo.innerHTML = `<h4>${user.Username}</h4> <br>
                                            <h4>${user.Name} ${user.Surname}</h4>
                                            <h4>${user.Email}</h4>
                                            <h4>${user.Birthday}</h4>
                                            <h4>${gender[user.Gender]}</h4>`;
                if (role == "PUTNIK") {
                    userInfo.innerHTML += '<h4> Reservations</h4>';
                } else if (role == "ADMINISTRATOR") {
                    //adminFilterUsersForm();
                    adminLoadUsersList();
                }
                document.querySelector('#password').value = user.Password;
                document.querySelector('#name').value = user.Name;
                document.querySelector('#surname').value = user.Surname;
                document.querySelector('#email').value = user.Email;
                document.querySelector('#birthday').value = user.Birthday;
                document.querySelector('#gender').value = user.Gender === 0 ? 'Male' : 'Female';
            });
        }

        function adminLoadUsersList() {
            $.get("api/users", function (data, status) {
                var tbody = $("#adminUsersTableBody");
                tbody.empty(); // Clear any existing rows
                data.forEach(function (user, index) {
                    var row = `<tr>
                                   <td>${index + 1}</td>
                                   <td>${user.Name}</td>
                                   <td>${user.Surname}</td>
                                   <td>${user.Birthday}</td>
                                   </tr>`;
                    tbody.append(row);
                });
            });
        }
        function editProfile() {
            userInfo.hidden = true;
            var editDiv = document.querySelector("#editDiv");
            editDiv.hidden = false;
        }

        document.getElementById('registerForm').addEventListener('submit', function (event) {
            event.preventDefault();

            var formData = {
                username: user.Username,
                password: document.getElementById('password').value,
                name: document.getElementById('name').value,
                surname: document.getElementById('surname').value,
                email: document.getElementById('email').value,
                birthday: document.getElementById('birthday').value,
                gender: document.getElementById('gender').value
            };

            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            }).then(response => {
                location.reload();
            });


        });

    </script>
</body>
</html>